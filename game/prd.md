PRD: 뱀서바이벌 스타일 생존 오토 배틀러 (React)

1. 개요
이 문서는 React 기반으로 캔버스 생존 오토 배틀러 게임을 구현하기 위한 명세입니다. 과도한 엔지니어링을 지양하고, 핵심 규칙을 명확히 하여 의도한 동작을 보장합니다.

2. 기술/배포
- 기술 스택: React(환경은 CRA 또는 Next.js 중 택1), TypeScript 권장(필수 아님)
- 배포: Vercel 또는 정적 호스팅
- 캔버스 크기: 800×600, 좌표계 (0,0) = 좌상단

3. 조작 및 이동
- 입력: 키보드 WASD/방향키. 모바일은 가상 조이스틱.
- 플레이어는 화면 밖으로 이동 불가(경계 클램핑).

4. HUD(점수/시간)
- 위치: 화면 최상단 중앙(top-center)에 가로 배치.
- 포맷: “Score: <총점> | Time: <mm:ss>”.
- 스타일: 상단 여백 8px, 중앙 정렬, 반투명 배경, 글자 14px.

4.1 화면/캔버스 레이아웃(반응형/정확한 스케일 수식)
- 논리 해상도(고정): 월드 좌표 800×600.
- 데스크톱: 캔버스 CSS 800×600 중앙 정렬.
- 모바일(기본 contain):
  - 컨테이너: `width: 100vw; height: 100vh; background: #000`.
  - 스케일/오프셋 계산(뷰포트 vw×vh):
    - `scale = min(vw/800, vh/600)`
    - `cssWidth = round(800*scale)`, `cssHeight = round(600*scale)`
    - `offsetLeft = floor((vw - cssWidth)/2)`, `offsetTop = floor((vh - cssHeight)/2)`
  - 캔버스 해상도(선명도):
    - `canvas.width = cssWidth * devicePixelRatio`
    - `canvas.height = cssHeight * devicePixelRatio`
    - 2D 컨텍스트에 `setTransform(devicePixelRatio*scale, 0, 0, devicePixelRatio*scale, 0, 0)` 적용
    - `imageSmoothingEnabled=false`
  - 입력 좌표(논리 좌표로 역변환):
    - `logicalX = (clientX - offsetLeft) / scale`
    - `logicalY = (clientY - offsetTop) / scale`
  - 안전영역: HUD/상태패널 배치에 `env(safe-area-inset-*)` 반영.
- 리사이즈/회전: `ResizeObserver + orientationchange`로 즉시(≤100ms) 재계산.
- 옵션(선택): `RENDER_MODE=cover` 일 때 `scale = max(vw/800, vh/600)`(잘림 허용, 중앙 크롭). HUD/패널은 항상 화면 내 표시.

5. 크기/스케일 요구사항
- 플레이어/적/보스: 원본 스프라이트 대비 10% 크기로 스케일링.
- 투사체: 원본 스프라이트 대비 10% 크기로 스케일링.
- 수용 기준: 렌더링된 이미지의 가로/세로가 원본 대비 지정 비율(±10% 오차) 이내.

6. 충돌 및 게임오버(고정 규칙)
- 규칙: 플레이어와 적의 경계가 닿는 프레임에 “즉시 게임오버(즉사)”.
- HP/피해량/무적시간 개념 없음. 접촉=사망.
- 상태 패널의 Life는 1로 표기(정보 제공용).
- 게임오버 시: 루프 정지, 게임오버 오버레이 표시.
  - 오버레이 항목: Final Score(총점), Kills(처치 수), Time(mm:ss), Restart 버튼.

7. 점수 규칙(시간 점수 + 처치 점수)
- 시간 점수: 1초당 1점(루프가 정지된 동안은 증가하지 않음).
- 처치 점수: 일반 적 1점, 보스 5점.
- 총점 = 시간 점수 + 처치 점수.

8. 자동 공격(오토 파이어)
- 기본: 일정 간격(예: 0.5초)으로 자동 발사. 가장 가까운 적 방향을 우선.
- 적이 없을 경우: 입력 벡터 방향으로 발사.
- 투사체 크기는 5번 스케일 규칙 준수(원본 10%).

9. 레벨업과 일시정지
- XP 부여 시점: 적 처치 “즉시” XP를 부여(일반 +1, 보스 +5). 같은 프레임에 임계치 도달 여부 검사.
- 조건: 경험치 임계(예: 10, 20, 40, 80, …) 도달 시 레벨업.
- 모달: 3개의 파워업 선택지를 모달로 표시.
- 정지: 모달이 열려 있는 동안 게임 루프 “완전 정지”. 아래가 모두 멈춤:
  - 플레이어/적 이동, 스폰, 충돌 판정, 발사, 경과 시간 증가, 점수 증가
- 선택 즉시: 파워업 적용 후 루프 재개. 초과 XP는 다음 레벨로 이월.

10. 모바일 입력(가상 조이스틱)과 스크롤/제스처 제어
- 조이스틱/캔버스 컨테이너 CSS:
  - `touch-action: none;`, `user-select: none;`, `overscroll-behavior: none;` 적용.
- 터치 이벤트 핸들링:
  - `touchstart`/`touchmove` 리스너는 `{ passive: false }`로 등록하고, 내부에서 `event.preventDefault()` 호출.
- 뷰포트 메타 태그:
  - `<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">` 지정.
- 레이아웃:
  - 앱 루트는 `height: 100vh`로 고정하여 문서 스크롤 방지.
- 표시/숨김 트리거(동적 조이스틱):
  - 모바일(pointer: coarse)에서 캔버스 또는 게임 영역을 “첫 터치”한 순간, 해당 터치 지점을 중심으로 조이스틱을 표시한다.
  - 드래그 중에는 계속 표시되며, 터치 종료 시 즉시 숨긴다. 고정형(좌하단 고정) 모드 옵션은 추가 가능.
- 조이스틱 벡터 산출:
  - 중심 반지름 50px 기준, -1..1 범위의 정규화 이동 벡터를 산출하고 키보드 입력 벡터와 합성한다.
  - 조이스틱 좌표는 항상 “논리 좌표” 기준으로 계산한다(위 4.1의 역변환 공식을 사용).
- 단일 터치/포인터 정책:
  - `pointerdown` 한 번으로 조이스틱 표시, 동일 이벤트에서 드래그 시작 및 벡터 산출(setPointerCapture 사용).
  - `pointerup/cancel`에서 즉시 조이스틱 숨김 및 외부 벡터 (0,0).
- 수용 기준:
  - 모바일 에뮬레이터에서 캔버스 첫 터치 시 1프레임 내 조이스틱이 표시되고, 드래그 방향에 따라 캐릭터가 이동한다.
  - 조이스틱 조작 중 페이지 스크롤/바운스/핀치줌이 발생하지 않는다. 터치 종료 시 조이스틱이 즉시 숨겨지고 이동 벡터는 (0,0)이다.

11. 유즈케이스 요약
- UC-01 게임 시작: 진입 시 초기화 후 즉시 시작. 플레이어는 중앙에 생성.
- UC-02 조작: 키보드/조이스틱으로 이동. 화면 밖 이동 불가.
- UC-03 적 스폰/이동: 일반 적은 주기적 스폰, 보스는 처치 누적(예: 50)마다 등장. 적은 플레이어를 추적.
- UC-04 자동 공격: 지정 간격으로 자동 발사. 타겟팅/방향 규칙 준수.
- UC-05 충돌: 플레이어-적 접촉 즉시 게임오버. 투사체-적 충돌 시 적 피해/처치 및 경험치/처치 점수 획득.
- UC-06 레벨업: 처치 XP가 임계 도달 시 모달 띄우고 전체 정지. 선택 후 재개.
- UC-07 게임오버: 오버레이에 Final Score, Kills, Time 표기와 재시작 제공.

11.1 캐릭터 상태 패널(좌측 상단)
- 위치: 화면 좌측 상단(top-left) 고정 패널.
- 항목: Life, Fire Rate(발사/초), Bullet Damage(탄 데미지). 필요 시 Level, XP 추가 가능.
- 포맷 예시: `Life: 1 | FireRate: 2.0/s | Damage: 1`
- 스타일: 반투명 배경, 12–14px 폰트, 프레임마다 최신 값 반영.

12. 모듈 구성(권장)
- hooks: 입력(useInput), 루프(useGameLoop), 플레이어(usePlayer), 적(useEnemies), 투사체(useProjectiles)
- components: 캔버스 렌더러(GameCanvas), HUD, LevelUpModal, GameOverScreen, VirtualJoystick
- types: 엔티티 타입/상수

13. 수용 기준(Definition of Done)
- 충돌/게임오버: 플레이어가 적과 접촉한 프레임 내에 게임오버 화면이 즉시 뜨고 루프가 정지한다.
- HUD 위치/표기: 점수/시간이 화면 최상단 중앙에 고정되며 포맷을 준수한다.
- 스케일: 플레이어/적/보스/투사체 모두 원본의 10%로 렌더링(±10% 오차 이내).
- 레벨업 정지: 모달이 열려 있는 동안 위치/스폰/발사/타이머/점수 값 모두 변하지 않는다.
- 점수: 처치 점수와 시간 점수가 합산되며, 10초간 처치 없이 유지 시 점수 10 증가.
- 게임오버 오버레이: Final Score, Kills, Time이 정확히 표기된다.
- 모바일 스크롤 제어: 조이스틱 조작 중 페이지 스크롤/바운스/핀치줌이 발생하지 않는다.
- 레벨업 트리거: 적 처치 프레임에 XP가 부여되고, 임계 도달 시 같은 프레임에 모달이 열린다(정지 상태 전환).
- 상태 패널: 게임 시작 즉시 좌측 상단에 표시되며, 업그레이드 선택 직후 값이 갱신된다.

13.2 반응형/캔버스 레이아웃
- 모바일 뷰포트(여러 해상도/종횡비)에서 전체 게임 월드가 화면 내에 온전히 보이며 화면 밖으로 벗어나 보이지 않는다(contain 기준). 검은 레터박스는 양옆 또는 상하에만 나타난다.
- 리사이즈/회전 시 캔버스가 100ms 이내 자연스럽게 재배치/재스케일되며 조작 좌표(논리 좌표 변환)가 정확하다(5점 샘플: 0,0 / 800,0 / 800,600 / 0,600 / 중앙 테스트).
- DPR에 따라 텍스트/스프라이트가 흐릿해지지 않고(스무딩 비활성), 스케일 후에도 HUD/상태 패널 위치가 의도한 곳에 유지된다(safe-area 반영).
- 확인 기기(예시): iPhone SE(375×667), iPhone 14 Pro Max(430×932), Galaxy S8(360×740), iPad(768×1024), Pixel 7(412×915)에서 이상 없음.

14. 성능
- 60 FPS 목표. 캔버스 한번에 전체 리렌더 가능. 필요시 스프라이트 캐싱.

15. 배포/환경
- 로컬: npm start로 개발 서버 실행. 브라우저 60FPS 확인.
- 프로덕션: 빌드 후 정적 호스팅 배포.

10.1 모바일 조이스틱(단일 터치/드래그 즉시 시작)
- 한 번의 터치(pointerdown)로 조이스틱을 터치 지점에 즉시 표시하고, 같은 이벤트로 드래그 상태를 시작하며 이동 벡터를 산출한다(추가 터치 불필요).
- Pointer Events 권장: pointerdown 시 setPointerCapture(pointerId)로 동일 포인터의 move/up을 안정적으로 수신한다. 대안으로 touchstart/touchmove/touchend 사용 시 리스너는 passive:false로 등록하고 preventDefault() 호출.
- 컨테이너/조이스틱: touch-action:none, overscroll-behavior:none, user-select:none 적용. 첫 pointerdown에서 preventDefault()로 스크롤/줌 방지.
- pointerup 시 조이스틱을 즉시 숨기고 외부 벡터를 (0,0)으로 초기화.
- 단일 포인터 정책: 활성 포인터 1개만 입력으로 사용. 드래그 중 새 pointerdown은 무시하거나 대체하지 않음.

10.2 레벨업 모달 중 입력/조이스틱 차단
- levelUp 모달이 열려 있는 동안 입력 캡처를 비활성화하고 조이스틱은 강제 숨김(visible=false).
- 레이어링: 모달 오버레이는 pointer-events:auto로 입력을 독점하고, 게임 컨테이너/조이스틱은 pointer-events:none 처리.
- 업그레이드 선택(모달 닫힘) 시에만 입력 캡처와 조이스틱 표시를 재개.

13.1 수용 기준 보강(모바일/레벨업)
- 모바일에서 화면을 한 번 터치하면 1프레임 내 조이스틱이 나타나고, 추가 터치 없이 드래그만으로 캐릭터가 이동한다.
- pointerup 시 조이스틱이 즉시 숨겨지고 이동이 멈춘다(벡터 = 0,0).
- 레벨업 모달이 열린 상태에서 화면을 터치/드래그해도 조이스틱이 생성되지 않으며, 모달 버튼은 정상적으로 터치/선택 가능하다.
- 레벨업 모달이 닫힌 직후에만 조이스틱 표시/입력이 재개된다.
